
<!DOCTYPE html>
<!-- CANÓNICA: verificación QR/Admin (pública). Usar esta para producción. -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Acceso - Academia COHAB (Admin)</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="COHAB Sistema">
    <meta name="description" content="Verificación de acceso por QR - Requiere autenticación admin">
    
    <!-- Manifest -->
    <link rel="manifest" href="../manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../img/logo_cohab.png">
    <link rel="apple-touch-icon" href="../img/logo_cohab.png">
    
    <link rel="stylesheet" href="../css/styles.css?v=14">
    <style>
        .status-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status-icon svg {
            width: 64px;
            height: 64px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <img src="../img/logo_cohab.svg" alt="Academia COHAB BJJ" class="logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDIwMCAxMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMwMDAwMDAiIHJ4PSI4Ii8+PHRleHQgeD0iMTAwIiB5PSI3MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtZmFtaWx5PSJBcmlhbCBCbGFjaywgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9IjkwMCIgbGV0dGVyLXNwYWNpbmc9IjJweCI+Q09IQUI8L3RleHQ+PC9zdmc+'">
            <ul class="nav-links">
                <li><a href="../index.html"><span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span> Inicio</a></li>
                <li><a href="../admin.html"><span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg></span> Panel Admin</a></li>
                <li><a href="verificar.html" class="active"><span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></span> Verificar QR</a></li>
                <li><a href="javascript:void(0)" onclick="logout()"><span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg></span> Cerrar Sesión</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <!-- Sección de Verificación -->
        <section class="verificar-section">
            <h2 style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Verificar Acceso (Admin)
            </h2>
            <p class="subtitle">Escanea el código QR del alumno o ingresa el ID manualmente para verificar su estado de pago</p>
            
            <div class="verificar-options">
                <div class="option-card">
                    <h3 style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                            <path d="M12 18h.01M8 6h8M8 10h8"/>
                        </svg>
                        Escanear QR
                    </h3>
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:center;">
                        <button class="btn btn-primary" onclick="startScanner()">Iniciar Cámara</button>
                        <button class="btn btn-secondary" onclick="stopScanner()">Detener Cámara</button>
                        <button class="btn btn-secondary" id="torchBtn" onclick="toggleTorch()" style="display:none; display: inline-flex; align-items: center; gap: 0.5rem;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 21h6M12 3v18M17 12H7"/>
                            </svg>
                            Linterna
                        </button>
                    </div>
                    <div style="margin-top:0.75rem; display:flex; gap:0.5rem; align-items:center; justify-content:center; flex-wrap:wrap;">
                        <select id="cameraSelect" class="btn" style="min-width:220px; background:#111827; color:#fff; border:1px solid #374151; display:none;" onchange="switchCamera(this.value)"></select>
                        <label class="btn btn-secondary" for="imageInput" style="cursor:pointer; display: inline-flex; align-items: center; gap: 0.5rem;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Subir imagen
                        </label>
                        <input id="imageInput" type="file" accept="image/*" capture="environment" style="display:none;" onchange="decodeFromImage(event)">
                    </div>
                    <div id="scanner-container" style="display: none;">
                        <div class="scanner-overlay">
                            <div class="scanner-frame">
                                <div class="scanner-corners">
                                    <div class="corner top-left"></div>
                                    <div class="corner top-right"></div>
                                    <div class="corner bottom-left"></div>
                                    <div class="corner bottom-right"></div>
                                </div>
                                <video id="video" autoplay muted playsinline></video>
                                <canvas id="canvas" style="display: none;"></canvas>
                            </div>
                            <div class="scanner-instructions">
                                <p style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                                        <path d="M12 18h.01"/>
                                    </svg>
                                    Apunta la cámara al código QR del alumno
                                </p>
                                <p style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    El código se detectará automáticamente
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="option-divider">O</div>
                
                <div class="option-card">
                    <h3 style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Ingreso Manual
                    </h3>
                    <input type="text" id="manualId" placeholder="Ingresa el ID del alumno">
                    <button class="btn btn-primary" onclick="verificarManual()">Verificar</button>
                </div>
            </div>
        </section>

        <!-- Resultado de Verificación -->
        <div id="resultadoVerificacion" class="resultado-container" style="display: none;">
            <div class="resultado-card">
                <div id="resultadoHeader" class="resultado-header">
                    <div class="status-icon" id="statusIcon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <h3 id="alumnoNombre">Nombre del Alumno</h3>
                    <p id="estadoPago">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="#10b981" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><circle cx="12" cy="12" r="10"/></svg>
                        Al día
                    </p>
                </div>
                
                <!-- Información del Alumno -->
                <div class="resultado-body">
                    <div class="info-section">
                        <h4 style="display: flex; align-items: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                            Información Personal
                        </h4>
                        <div class="info-row">
                            <span class="label">ID del Alumno:</span>
                            <span class="value" id="alumnoId">ID123456</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Email:</span>
                            <span class="value" id="alumnoEmail">alumno@email.com</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Teléfono:</span>
                            <span class="value" id="alumnoTelefono">+1234567890</span>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h4 style="display: flex; align-items: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Estado de Pago
                        </h4>
                        <div class="info-row">
                            <span class="label">Último Pago:</span>
                            <span class="value" id="ultimoPago">01/01/2024</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Próximo Pago:</span>
                            <span class="value" id="proximoPago">01/02/2024</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Monto Mensual:</span>
                            <span class="value" id="montoMensual">$50.00</span>
                        </div>
                        <div class="info-row" id="diasRestantesRow">
                            <span class="label">Días Restantes:</span>
                            <span class="value" id="diasRestantes">15 días</span>
                        </div>
                        <div class="info-row" id="diasAtrasadosRow" style="display: none;">
                            <span class="label">Días Atrasado:</span>
                            <span class="value" id="diasAtrasados">5 días</span>
                        </div>
                    </div>
                    
                    <!-- Código QR del Alumno -->
                    <div class="qr-section">
                        <h4 style="display: flex; align-items: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="5" height="5"/>
                                <rect x="16" y="3" width="5" height="5"/>
                                <rect x="3" y="16" width="5" height="5"/>
                                <path d="M21 16h-3a2 2 0 0 1-2-2v-3"/>
                            </svg>
                            Código QR del Alumno
                        </h4>
                        <div id="qrDisplay" class="qr-display">
                            <!-- El QR se generará aquí -->
                        </div>
                        <div class="qr-info">
                            <p><strong>ID:</strong> <span id="qrId">ID123456</span></p>
                            <p id="qrUrlDisplay" style="font-size: 0.75rem; word-break: break-all; color: #059669; margin: 0.5rem 0;"></p>
                            <button class="btn btn-small" onclick="downloadQR()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Descargar QR
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="resultado-footer">
                    <button class="btn btn-success" onclick="registrarPago()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                            <line x1="1" y1="10" x2="23" y2="10"/>
                        </svg>
                        Registrar Pago
                    </button>
                    <button class="btn btn-primary" onclick="mostrarQRCompleto()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="5" height="5"/>
                            <rect x="16" y="3" width="5" height="5"/>
                            <rect x="3" y="16" width="5" height="5"/>
                            <path d="M21 16h-3a2 2 0 0 1-2-2v-3"/>
                        </svg>
                        Ver QR Completo
                    </button>
                    <button class="btn btn-secondary" onclick="cerrarResultado()">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Vista Rápida de Todos los Alumnos -->
        <section class="todos-alumnos-section">
            <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Vista Rápida - Todos los Alumnos
            </h3>
            <p class="subtitle">Haz clic en cualquier tarjeta para verificar su estado. También puedes agregar alumnos nuevos aquí.</p>
            
            <div class="filter-buttons" style="display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <button class="filter-btn active" onclick="filterStatus('all')">Todos</button>
                <button class="filter-btn" onclick="filterStatus('atrasado')" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#ef4444"><circle cx="12" cy="12" r="10"/></svg>
                    Atrasados
                </button>
                <button class="filter-btn" onclick="filterStatus('proximo')" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#f59e0b"><circle cx="12" cy="12" r="10"/></svg>
                    Próximos a vencer
                </button>
                <button class="filter-btn" onclick="filterStatus('aldia')" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#10b981"><circle cx="12" cy="12" r="10"/></svg>
                    Al día
                </button>
                <button class="btn btn-primary" onclick="openModalVerificar()" style="margin-left: auto;">+ Agregar alumno</button>
            </div>
            
            <div id="todosAlumnos" class="todos-alumnos-grid">
                <!-- Los alumnos se cargarán aquí dinámicamente -->
            </div>
        </section>
    </main>

    <!-- Modal Agregar alumno (Verificar QR) -->
    <div id="verificarAlumnoModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModalVerificar()">&times;</span>
            <h2>Agregar nuevo alumno</h2>
            <p class="subtitle" style="margin-bottom: 1rem;">Completa los datos. El alumno quedará en la lista y podrás generar su QR.</p>
            <form id="verificarAlumnoForm" onsubmit="saveAlumnoVerificar(event)">
                <div class="form-group">
                    <label for="verificarNombre">Nombre completo *</label>
                    <input type="text" id="verificarNombre" required placeholder="Ej. Juan Pérez">
                </div>
                <div class="form-group">
                    <label for="verificarEmail">Email</label>
                    <input type="email" id="verificarEmail" placeholder="opcional">
                </div>
                <div class="form-group">
                    <label for="verificarTelefono">Teléfono</label>
                    <input type="tel" id="verificarTelefono" placeholder="opcional">
                </div>
                <div class="form-group">
                    <label for="verificarFechaPago">Fecha de último pago *</label>
                    <input type="date" id="verificarFechaPago" required>
                </div>
                <div class="form-group">
                    <label>Día de pago mensual *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" id="verificarBtnDia30" class="btn btn-secondary" onclick="setDiaPagoVerificar(30)">Día 30</button>
                        <button type="button" id="verificarBtnDia31" class="btn btn-secondary" onclick="setDiaPagoVerificar(31)">Día 31</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="verificarMonto">Monto mensual *</label>
                    <input type="number" id="verificarMonto" step="0.01" min="0" required placeholder="Ej. 50">
                </div>
                <div class="form-actions" style="margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModalVerificar()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar alumno</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="../js/cohab-config.js?v=1"></script>
    <script src="../js/mongodb-client.js?v=6"></script>
    <script src="../js/alert-system.js"></script>
    <script src="../js/verificar.js?v=22"></script>
    
    <script>
        // Verificación de acceso - Admin tiene acceso completo
        function checkVerifierAccess() {
            const userRole = localStorage.getItem('cohabUserRole') || localStorage.getItem('userRole');
            const hasToken = localStorage.getItem('cohabAuthToken');
            
            // Admin con token tiene acceso
            if (userRole === 'admin' && hasToken) {
                return true;
            }
            // Verifier también tiene acceso (legacy)
            if (userRole === 'verifier') {
                return true;
            }
            
            alert('Acceso denegado. Esta función requiere rol de Administrador.');
            window.location.href = '../login.html?role=admin';
            return false;
        }
        
        // Verificar acceso ANTES de inicializar acciones
        const __HAS_VERIFIER_ACCESS__ = checkVerifierAccess();
        
        // Cerrar sesión
        async function logout() {
            const ok = await confirm('¿Estás seguro de cerrar sesión?');
            if (!ok) return;
            // Limpiar todas las variables de auth
            localStorage.removeItem('userRole');
            localStorage.removeItem('cohabUserRole');
            localStorage.removeItem('cohabAuthToken');
            localStorage.removeItem('cohabUser');
            localStorage.removeItem('lastAccess');
            sessionStorage.clear();
            window.location.href = '../login.html';
        }
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('../sw.js')
                    .then(function(registration) {
                        // no-op: evitar ruido en consola
                    })
                    .catch(function(error) {
                        // no-op: evitar ruido en consola
                    });
            });
        }
    </script>
</body>
</html>
