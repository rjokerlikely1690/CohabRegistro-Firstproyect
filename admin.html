<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrador - Academia COHAB</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="COHAB Admin">
    <meta name="description" content="Panel de Administraci√≥n - Academia COHAB">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="img/logo_cohab.png">
    <link rel="apple-touch-icon" href="img/logo_cohab.png">
    
    <link rel="stylesheet" href="css/styles.css?v=12">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        .admin-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .admin-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .admin-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .role-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid;
        }
        
        .stat-card.aldia { border-left-color: #10b981; }
        .stat-card.proximo { border-left-color: #f59e0b; }
        .stat-card.atrasado { border-left-color: #dc2626; }
        .stat-card.total { border-left-color: #6366f1; }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        /* N√∫meros con color seg√∫n el estado (verde=al d√≠a, amarillo=pr√≥ximos, rojo=atrasados, neutro=total) */
        .stat-card.total .stat-number { color: #374151; }
        .stat-card.aldia .stat-number { color: #059669; }
        .stat-card.proximo .stat-number { color: #d97706; }
        .stat-card.atrasado .stat-number { color: #dc2626; }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .quick-action-btn {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            color: #1f2937;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quick-action-btn:hover {
            border-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        }
        
        .quick-action-icon {
            font-size: 2rem;
        }
        
        .quick-action-label {
            font-weight: 600;
        }
        
        .error-message {
            background: #fee2e2;
            border: 1px solid #dc2626;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="container">
            <div class="admin-nav">
            <div class="admin-nav-left">
                    <h1><span class="nav-icon" style="display:inline-flex; width:28px; height:28px; vertical-align:middle; margin-right:0.5rem;"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg></span>Panel Administrador</h1>
                    <span class="role-badge">ADMIN</span>
            </div>
                <div class="admin-nav-right">
                    <button onclick="forceSync()" title="Forzar sincronizaci√≥n" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; width: 36px; height: 36px;">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                    </button>
                    <button onclick="window.location.href='index.html'" class="btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem;">
                        <span class="nav-icon" style="width:18px; height:18px;"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span> Inicio
                    </button>
                    <button onclick="logout()" class="btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem;">
                        <span class="nav-icon" style="width:18px; height:18px;"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg></span> Salir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="errorContainer"></div>
        
        <div class="admin-stats">
            <div class="stat-card total">
                <div class="stat-number" id="totalAlumnos">---</div>
                <div class="stat-label">Total Alumnos</div>
            </div>
            <div class="stat-card aldia">
                <div class="stat-number" id="alumnosAldia">---</div>
                <div class="stat-label">Al D√≠a</div>
            </div>
            <div class="stat-card proximo">
                <div class="stat-number" id="alumnosProximo">---</div>
                <div class="stat-label">Pr√≥ximos a Vencer</div>
            </div>
            <div class="stat-card atrasado">
                <div class="stat-number" id="alumnosAtrasados">---</div>
                <div class="stat-label">Atrasados</div>
            </div>
        </div>

        <div class="quick-actions">
            <a href="gestion-alumnos.html" class="quick-action-btn">
                <span class="quick-action-icon"><svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></span>
                <span class="quick-action-label">Gesti√≥n de Alumnos</span>
                <span style="font-size: 0.8rem; color: #666;">Agregar, editar y eliminar</span>
            </a>
            
            <a href="public/verificar.html" class="quick-action-btn">
                <span class="quick-action-icon"><svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></span>
                <span class="quick-action-label">Verificar Pagos</span>
                <span style="font-size: 0.8rem; color: #666;">Escanear QR y validar</span>
            </a>
            
            <button onclick="refreshStats()" class="quick-action-btn">
                <span class="quick-action-icon"><svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></span>
                <span class="quick-action-label">Actualizar Estad√≠sticas</span>
                <span style="font-size: 0.8rem; color: #666;">Recargar datos</span>
            </button>
            </div>
            </div>
            
    <!-- MongoDB Client -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="js/cohab-config.js?v=2"></script>
    <script src="js/auth-client.js?v=2"></script>
    <script src="js/mongodb-client.js?v=8"></script>
    <script src="js/app.js?v=29"></script>
    
    <script>
        // Verificar autenticaci√≥n admin al cargar
        (function checkAdminAuth() {
            const token = localStorage.getItem('cohabAuthToken');
            const role = localStorage.getItem('cohabUserRole');
            if (!token || role !== 'admin') {
                window.location.href = 'login.html';
                return;
            }
        })();
        
        // ‚ö†Ô∏è MongoDB es la √∫nica fuente de verdad
        // NO usar localStorage para datos de negocio
        
        // Usar solo el estado que env√≠a el backend (fuente √∫nica de verdad para fechas)
        function getEstadoFromBackend(alumno) {
            if (alumno && alumno.clase != null) return { clase: alumno.clase, texto: alumno.texto || 'Sin datos' };
            return { clase: 'atrasado', texto: 'Sin datos' };
        }
        
        // Actualizar estad√≠sticas desde MongoDB
        async function updateStats() {
            try {
                if (!window.MONGO || !MONGO.isConfigured()) {
                    throw new Error('MongoDB no est√° configurado. Verifica la conexi√≥n del backend.');
                }
                
                const alumnos = await MONGO.listAlumnos();
                
                if (!Array.isArray(alumnos)) {
                    throw new Error('Respuesta inv√°lida del servidor');
                }
                
            let total = alumnos.length;
            let aldia = 0;
            let proximo = 0;
            let atrasados = 0;
                
            alumnos.forEach(alumno => {
                const estado = getEstadoFromBackend(alumno);
                if (estado.clase === 'al-dia') aldia++;
                else if (estado.clase === 'proximo') proximo++;
                else if (estado.clase === 'atrasado') atrasados++;
            });
                
            document.getElementById('totalAlumnos').textContent = total;
            document.getElementById('alumnosAldia').textContent = aldia;
            document.getElementById('alumnosProximo').textContent = proximo;
            document.getElementById('alumnosAtrasados').textContent = atrasados;
                
                console.log('‚úÖ Estad√≠sticas actualizadas desde MongoDB:', { total, aldia, proximo, atrasados });
                
                // Limpiar errores si existen
                document.getElementById('errorContainer').innerHTML = '';
                
            } catch (error) {
                console.error('‚ùå Error al actualizar estad√≠sticas:', error);
                
                // Si es error de autenticaci√≥n, redirigir a login
                if (error.message && (error.message.includes('No autenticado') || error.message.includes('Sesi√≥n'))) {
                    window.location.href = 'login.html?role=admin';
                    return;
                }
                
                const errorContainer = document.getElementById('errorContainer');
                errorContainer.innerHTML = `
                    <div class="error-message">
                        <strong>‚ùå Error al cargar estad√≠sticas</strong>
                        <p>${error.message || 'No se pudo conectar con la base de datos'}</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">
                            <strong>Soluci√≥n:</strong> Aseg√∫rate de que el servidor backend est√© corriendo
                        </p>
                        <button onclick="updateStats()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
                            üîÑ Reintentar
                        </button>
                    </div>
                `;
                
                document.getElementById('totalAlumnos').textContent = '---';
                document.getElementById('alumnosAldia').textContent = '---';
                document.getElementById('alumnosProximo').textContent = '---';
                document.getElementById('alumnosAtrasados').textContent = '---';
            }
        }

        // Refrescar estad√≠sticas
        function refreshStats() {
            updateStats();
        }
        
        // Forzar sincronizaci√≥n - limpia cach√© y recarga
        async function forceSync() {
            try {
                // Limpiar Service Worker caches
                if ('caches' in window) {
                    const names = await caches.keys();
                    await Promise.all(names.map(n => caches.delete(n)));
                }
                // Limpiar localStorage excepto auth
                const authToken = localStorage.getItem('cohabAuthToken');
                const authRole = localStorage.getItem('cohabUserRole');
                const authUser = localStorage.getItem('cohabUser');
                localStorage.clear();
                if (authToken) localStorage.setItem('cohabAuthToken', authToken);
                if (authRole) localStorage.setItem('cohabUserRole', authRole);
                if (authUser) localStorage.setItem('cohabUser', authUser);
                // Recargar
                location.reload(true);
            } catch (e) {
                console.error('Error en forceSync:', e);
                location.reload(true);
            }
        }
        
        // Cerrar sesi√≥n (usa AUTH client)
        async function logout() {
            if (typeof AUTH !== 'undefined') {
                await AUTH.logout();
            }
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }
        
        // Inicializar con verificaci√≥n de auth
        window.addEventListener('DOMContentLoaded', async () => {
            // Verificar autenticaci√≥n admin
            let isAuthenticated = false;
            
            // Primero verificar localStorage (login reciente)
            const storedRole = localStorage.getItem('cohabUserRole');
            const storedUser = localStorage.getItem('cohabUser');
            
            if (storedRole === 'admin' && storedUser) {
                // Tenemos datos locales, asumir autenticado temporalmente
                isAuthenticated = true;
                console.log('‚úÖ Usuario admin (localStorage)');
            }
            
            // Intentar verificar con el servidor (no bloquear si falla)
            if (typeof AUTH !== 'undefined') {
                try {
                    const user = await AUTH.checkAuth();
                    if (user && user.role === 'admin') {
                        isAuthenticated = true;
                        console.log('‚úÖ Usuario autenticado (servidor):', user.nombre);
                    } else if (user && user.role !== 'admin') {
                        // Usuario existe pero no es admin
                        isAuthenticated = false;
                    }
                    // Si user es null pero tenemos localStorage, mantener isAuthenticated
                } catch (error) {
                    console.warn('‚ö†Ô∏è No se pudo verificar con servidor:', error.message);
                    // Mantener el estado de localStorage si existe
                }
            }
            
            if (!isAuthenticated) {
                window.location.href = 'login.html?role=admin';
                return;
            }
            
            console.log('üîê Panel de Administrador cargado');
            console.log('‚ö†Ô∏è MongoDB es la √∫nica fuente de verdad');
            
            await updateStats();
        });
    </script>
</body>
</html> 
