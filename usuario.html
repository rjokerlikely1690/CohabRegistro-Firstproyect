<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Estado de Pago - Academia COHAB (ACTUALIZADO)</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="COHAB Usuario">
    <meta name="description" content="Consulta tu estado de pago - Academia COHAB">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="img/logo_cohab.png">
    <link rel="apple-touch-icon" href="img/logo_cohab.png">
    
    <link rel="stylesheet" href="css/styles.css?v=9">
    <style>
        .user-header {
            background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
        }
        
        .user-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .role-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .user-welcome {
            text-align: center;
        }
        
        .user-welcome h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .user-welcome p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .search-section {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .search-title {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .search-title h2 {
            color: #dc2626;
            margin-bottom: 0.5rem;
        }
        
        .search-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .search-option {
            text-align: center;
            padding: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        
        .search-option:hover {
            border-color: #dc2626;
            transform: translateY(-2px);
        }
        
        .search-option .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .search-option h3 {
            margin-bottom: 1rem;
            color: #374151;
        }
        
        .search-option p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        
        .camera-container {
            display: none;
            text-align: center;
            margin-top: 1rem;
        }
        
        .camera-container video {
            max-width: 100%;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .manual-search {
            display: none;
        }
        
        .manual-search input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .manual-search input:focus {
            outline: none;
            border-color: #dc2626;
        }
        
        .result-container {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }
        
        .result-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .status-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .status-aldia { color: #10b981; }
        .status-proximo { color: #f59e0b; }
        .status-atrasado { color: #dc2626; }
        
        .result-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .info-item {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #dc2626;
        }
        
        .info-item .label {
            font-weight: bold;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .info-item .value {
            color: #6b7280;
        }
        
        .alert-banner {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .alert-banner.atrasado {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }
        
        .alert-banner.proximo {
            background: #fffbeb;
            border-color: #fed7aa;
            color: #d97706;
        }
        
        @media (max-width: 768px) {
            .search-options {
                grid-template-columns: 1fr;
            }
            
            .result-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <img src="img/logo_cohab.svg" alt="Academia COHAB BJJ" class="logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDIwMCAxMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMwMDAwMDAiIHJ4PSI4Ii8+PHRleHQgeD0iMTAwIiB5PSI3MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtZmFtaWx5PSJBcmlhbCBCbGFjaywgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9IjkwMCIgbGV0dGVyLXNwYWNpbmc9IjJweCI+Q09IQUI8L3RleHQ+PC9zdmc+'">
            <ul class="nav-links">
                <li><a href="index.html"><span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span> Inicio</a></li>
                <li><a href="usuario.html" class="active"><span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></span> Mi Estado</a></li>
                <li><a href="login.html"><span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg></span> Acceso Admin</a></li>
            </ul>
        </div>
    </nav>

    <div class="user-header" style="background: linear-gradient(135deg, #dc2626 0%, #7f1d1d 100%) !important;">
        <div class="container">
            <div class="user-nav">
                <div class="role-badge" style="font-size: 0.8rem; padding: 0.3rem 0.7rem;">ğŸ‘¤ USUARIO</div>
                <button class="btn btn-secondary" onclick="logout()" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); padding: 0.5rem 1rem; font-size: 0.9rem;">Cerrar</button>
            </div>
            
            <div class="user-welcome">
                <h1 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Â¡Hola! ğŸ‘‹</h1>
                <p style="font-size: 1rem; opacity: 0.9;">Consulta tu estado de pago</p>
            </div>
        </div>
    </div>

    <main class="container">
        <section class="search-section">
            <div class="search-title">
                <h2>ğŸ” Consultar Estado de Pago</h2>
                <p>EscanÃ©a tu cÃ³digo QR o ingresa tu ID para verificar tu estado</p>
            </div>
            
            <div class="search-options">
                <div class="search-option">
                    <div class="icon">ğŸ“±</div>
                    <h3>Escanear CÃ³digo QR</h3>
                    <p>Usa la cÃ¡mara de tu dispositivo para escanear tu cÃ³digo QR</p>
                    <button class="btn btn-primary" onclick="toggleCamera()">Iniciar CÃ¡mara</button>
                    
                    <div class="camera-container" id="cameraContainer">
                        <video id="video" width="300" height="200" autoplay></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <button class="btn btn-secondary" onclick="stopCamera()">Detener CÃ¡mara</button>
                    </div>
                </div>
                
                <div class="search-option">
                    <div class="icon">âœï¸</div>
                    <h3>Ingreso Manual</h3>
                    <p>Ingresa tu ID de alumno para consultar tu estado</p>
                    <button class="btn btn-primary" onclick="toggleManualSearch()">Buscar por ID</button>
                    
                    <div class="manual-search" id="manualSearch">
                        <input type="text" id="userIdInput" placeholder="Ingresa tu ID de alumno">
                        <button class="btn btn-primary" onclick="searchByUserId()">Consultar Estado</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Resultado de la consulta -->
        <div class="result-container" id="resultContainer">
            <div class="result-header">
                <div class="status-icon" id="statusIcon">âœ…</div>
                <h2 id="studentName">Nombre del Alumno</h2>
                <p id="paymentStatus" class="status-aldia">ğŸŸ¢ Al dÃ­a con los pagos</p>
            </div>
            
            <div id="alertBanner" class="alert-banner" style="display: none;">
                <!-- Alertas se mostrarÃ¡n aquÃ­ -->
            </div>
            
            <div class="result-info" id="resultInfo">
                <!-- InformaciÃ³n del alumno se mostrarÃ¡ aquÃ­ -->
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="closeResult()">Nueva Consulta</button>
                <button class="btn btn-primary" onclick="shareStudentUrl()">ğŸ”— Compartir Mi Estado</button>
                <button class="btn btn-primary" onclick="showHistory()">Ver Historial</button>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="js/mongodb-client.js?v=6"></script>
    <script src="js/alert-system.js"></script>
    
    <script>
        // VERIFICACIÃ“N TEMPRANA: Si hay un ID en la URL, NO permitir redirecciones
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const hasId = urlParams.has('id') || window.location.pathname.includes('/alumno/');
            
            if (hasId) {
                console.log('ğŸ”’ Modo acceso pÃºblico detectado - bloqueando redirecciones automÃ¡ticas');
                // Prevenir cualquier redirecciÃ³n automÃ¡tica
                window.__BLOCK_REDIRECTS__ = true;
            }
        })();
        
        let video, canvas, context, scanning = false;
        let currentStudent = null;

        // RUT (Chile): atributo secundario; solo se valida si viene en la URL. ID = identificador corto.
        function normalizeRut(str) {
            if (!str || typeof str !== 'string') return '';
            var cleaned = str.replace(/\./g, '').replace(/\s/g, '').toUpperCase().trim();
            var match = cleaned.match(/^(\d{1,8})-?([0-9K])$/);
            return match ? match[1] + '-' + match[2] : '';
        }
        function validateChileanRut(rut) {
            var n = normalizeRut(rut);
            if (!n) return { valid: false };
            var parts = n.split('-');
            var body = parts[0], dv = parts[1];
            var digits = body.split('').map(Number).reverse();
            var series = [2,3,4,5,6,7,2,3,4,5,6,7,2,3,4,5,6,7];
            var sum = 0;
            for (var i = 0; i < digits.length; i++) sum += digits[i] * (series[i] || 2);
            var rest = 11 - (sum % 11);
            var expectedDv = rest === 11 ? '0' : rest === 10 ? 'K' : String(rest);
            if (dv !== expectedDv) return { valid: false };
            return { valid: true, normalized: n };
        }
        function getRutFromUrl() {
            var params = new URLSearchParams(window.location.search);
            var rut = params.get('rut');
            return (rut && typeof rut === 'string') ? rut.trim() : null;
        }
        function getRutFromInput(input) {
            if (!input || typeof input !== 'string') return null;
            try {
                if (input.startsWith('http') || input.includes('?')) {
                    var url = input.startsWith('http') ? new URL(input) : new URL('https://x/?' + (input.split('?')[1] || ''));
                    var r = url.searchParams.get('rut');
                    return (r && r.trim()) ? r.trim() : null;
                }
            } catch (e) {}
            return null;
        }

        // Limpiar y extraer ID de una URL o string
        function extractStudentId(input) {
            if (!input) return null;
            
            // Si es una URL completa, extraer el ID del parÃ¡metro
            if (input.includes('usuario.html?id=')) {
                const match = input.match(/[?&]id=([^&]+)/);
                if (match && match[1]) {
                    return decodeURIComponent(match[1]);
                }
            }
            
            // Si es una URL con /alumno/
            if (input.includes('/alumno/')) {
                const match = input.match(/\/alumno\/([^\/\?]+)/);
                if (match && match[1]) {
                    return decodeURIComponent(match[1]);
                }
            }
            
            // Si parece una URL completa, intentar extraer el Ãºltimo segmento
            if (input.startsWith('http')) {
                try {
                    const url = new URL(input);
                    const idParam = url.searchParams.get('id');
                    if (idParam) return idParam;
                    
                    // Intentar desde pathname
                    const pathMatch = url.pathname.match(/\/alumno\/([^\/]+)/);
                    if (pathMatch && pathMatch[1]) {
                        return decodeURIComponent(pathMatch[1]);
                    }
                } catch (e) {
                    // Si no es una URL vÃ¡lida, continuar
                }
            }
            
            // Si no es una URL, devolver tal cual (limpio)
            return input.trim();
        }

        function getStudentIdFromUrl() {
            console.log('ğŸ” getStudentIdFromUrl() - Analizando URL...');
            console.log('   - window.location.href:', window.location.href);
            console.log('   - window.location.search:', window.location.search);
            console.log('   - window.location.pathname:', window.location.pathname);
            
            // Intentar obtener desde query parameter
            const params = new URLSearchParams(window.location.search);
            const queryId = params.get('id');
            console.log('   - queryId obtenido:', queryId);
            
            if (queryId) {
                // Limpiar el ID por si acaso viene con una URL completa
                const cleanId = extractStudentId(queryId) || queryId.trim();
                console.log('   - ID limpio desde query:', cleanId);
                if (cleanId) return cleanId;
            }

            // Intentar obtener desde pathname (/alumno/ID)
            const pathMatch = window.location.pathname.match(/\/alumno\/([^\/]+)/i);
            if (pathMatch && pathMatch[1]) {
                const pathId = decodeURIComponent(pathMatch[1]);
                console.log('   - ID desde pathname:', pathId);
                return pathId;
            }

            console.log('   - âŒ No se encontrÃ³ ID en la URL');
            return null;
        }
        
        // Cargar alumnos desde MongoDB (Ãºnica fuente de verdad)
        async function loadAlumnosFromCloud() {
            console.log('â˜ï¸ loadAlumnosFromCloud() - Iniciando carga desde MongoDB...');
            
            try {
                if (!window.MONGO || !MONGO.isConfigured()) {
                    throw new Error('MongoDB no estÃ¡ configurado. Por favor configÃºralo en el panel de administraciÃ³n.');
                }
                
                console.log('ğŸ“¡ Intentando cargar desde MongoDB...');
                const alumnos = await MONGO.listAlumnos();
                console.log('ğŸ“¡ Respuesta de MongoDB:', alumnos);
                
                if (!Array.isArray(alumnos)) {
                    throw new Error('Respuesta invÃ¡lida del servidor');
                }
                
                console.log('âœ… Alumnos cargados desde MongoDB:', alumnos.length);
                return alumnos;
                
            } catch (error) {
                console.error('âŒ Error cargando alumnos desde MongoDB:', error);
                console.error('   - Stack:', error.stack);
                
                // âš ï¸ NO usar localStorage como fallback
                // Si MongoDB falla, el sistema debe fallar explÃ­citamente
                throw error;
            }
        }

        // Verificar que el usuario tenga permisos de usuario
        function checkUserAccess() {
            // BLOQUEAR redirecciones si hay un ID en la URL (acceso pÃºblico)
            if (window.__BLOCK_REDIRECTS__) {
                console.log('ğŸ”’ RedirecciÃ³n bloqueada - acceso pÃºblico activo');
                return true;
            }
            
            // PRIMERO verificar si hay un ID en la URL (acceso pÃºblico)
            const publicId = getStudentIdFromUrl();
            if (publicId) {
                console.log('âœ… Acceso pÃºblico detectado con ID:', publicId);
                window.__BLOCK_REDIRECTS__ = true; // Bloquear futuras redirecciones
                return true; // acceso pÃºblico vÃ­a QR o enlace directo - NO redirigir
            }

            // Si no hay ID pÃºblico, verificar roles de usuario
            const userRole = localStorage.getItem('userRole');
            if (userRole === 'usuario' || userRole === 'admin') {
                return true;
            }

            // Solo redirigir si NO hay ID pÃºblico y NO hay rol de usuario
            // PERO verificar nuevamente que no haya ID antes de redirigir
            const doubleCheckId = getStudentIdFromUrl();
            if (doubleCheckId) {
                console.log('âœ… ID detectado en verificaciÃ³n doble - bloqueando redirecciÃ³n');
                window.__BLOCK_REDIRECTS__ = true;
                return true;
            }
            
            console.log('âš ï¸ Acceso denegado - redirigiendo a login');
            alert('Acceso denegado. Inicia sesiÃ³n como usuario para ver tu estado.');
                window.location.href = 'login.html';
                return false;
        }

        // FunciÃ³n de logout
        async function logout() {
            const ok = await confirm('Â¿EstÃ¡s seguro de cerrar sesiÃ³n?');
            if (!ok) return;
            localStorage.removeItem('userRole');
            localStorage.removeItem('lastAccess');
            window.location.href = 'login.html';
        }

        // Alternar cÃ¡mara
        function toggleCamera() {
            const container = document.getElementById('cameraContainer');
            if (container.style.display === 'none') {
                startCamera();
            } else {
                stopCamera();
            }
        }

        // Iniciar cÃ¡mara
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                video = document.getElementById('video');
                canvas = document.getElementById('canvas');
                context = canvas.getContext('2d');
                
                video.srcObject = stream;
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('manualSearch').style.display = 'none';
                
                scanning = true;
                scanQR();
            } catch (err) {
                alert('Error al acceder a la cÃ¡mara: ' + err.message);
            }
        }

        // Detener cÃ¡mara
        function stopCamera() {
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('cameraContainer').style.display = 'none';
            scanning = false;
        }

        // Escanear QR
        function scanQR() {
            if (!scanning) return;
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    stopCamera();
                    searchByUserId(code.data);
                }
            }
            
            requestAnimationFrame(scanQR);
        }

        // Alternar bÃºsqueda manual
        function toggleManualSearch() {
            const manualSearch = document.getElementById('manualSearch');
            if (manualSearch.style.display === 'none') {
                manualSearch.style.display = 'block';
                document.getElementById('cameraContainer').style.display = 'none';
                stopCamera();
            } else {
                manualSearch.style.display = 'none';
            }
        }

        // ============================================================
        // FUNCIÃ“N PRINCIPAL DE VALIDACIÃ“N - SIN FALLBACKS
        // options.rutFromUrl: si la URL trae RUT, se valida contra el alumno.
        // ============================================================
        async function searchByUserId(userId, options) {
            options = options || {};
            var rutFromUrl = options.rutFromUrl || null;
            if (!rutFromUrl && userId) rutFromUrl = getRutFromInput(userId);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” [PASO 1] searchByUserId() INICIADO');
            console.log('   Input recibido:', userId);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // PASO 1: Obtener userId si no se proporcionÃ³
            if (!userId) {
                userId = document.getElementById('userIdInput') ? document.getElementById('userIdInput').value.trim() : null;
            }
            
            if (!userId) {
                console.error('âŒ [PASO 1] No se proporcionÃ³ userId');
                showCustomAlert('ID requerido', 'Por favor ingresa un ID de alumno para buscar', 'warning');
                return;
            }
            
            // PASO 2: Extraer ID limpio (ID corto; RUT no reemplaza al ID)
            const cleanId = extractStudentId(userId);
            console.log('ğŸ” [PASO 2] ID extraÃ­do:', cleanId);
            
            if (!cleanId) {
                console.error('âŒ [PASO 2] ID invÃ¡lido despuÃ©s de extraer');
                showCustomAlert('ID invÃ¡lido', 'El ID proporcionado no es vÃ¡lido', 'error');
                return;
            }
            
            // PASO 3: Verificar configuraciÃ³n de MongoDB
            console.log('ğŸ” [PASO 3] Verificando configuraciÃ³n de MongoDB...');
            if (!window.MONGO || !MONGO.isConfigured()) {
                console.error('âŒ [PASO 3] MongoDB NO CONFIGURADA');
                
                // ERROR EXPLÃCITO: No hay fallback, solo error claro
                showCustomAlert(
                    'Error de configuraciÃ³n del sistema',
                    'El sistema de validaciÃ³n no estÃ¡ configurado correctamente.\n\n' +
                    'Por favor contacta al administrador para configurar MongoDB.\n\n' +
                    'Sin esta configuraciÃ³n, no es posible validar suscripciones.',
                    'error'
                );
                
                // Mostrar secciÃ³n de bÃºsqueda para que el usuario pueda intentar de nuevo
                const searchSection = document.querySelector('.search-section');
                if (searchSection) {
                    searchSection.style.display = 'block';
                }
                return;
            }
            
            console.log('âœ… [PASO 3] MongoDB configurada');
            
            // PASO 4: Llamar al endpoint de validaciÃ³n
            console.log('ğŸ“¡ [PASO 4] Llamando a validaciÃ³n de MongoDB...');
            console.log('   ID a validar:', cleanId);
            
            try {
                const inicioRequest = Date.now();
                const resultado = await MONGO.validarSuscripcion(cleanId);
                const tiempoRequest = Date.now() - inicioRequest;
                
                console.log('âœ… [PASO 4] Respuesta recibida del backend');
                console.log('   Tiempo de respuesta:', tiempoRequest + 'ms');
                console.log('   Respuesta completa:', resultado);
                
                // PASO 5: Validar estructura de respuesta
                console.log('ğŸ” [PASO 5] Validando estructura de respuesta...');
                if (!resultado || typeof resultado.acceso !== 'boolean') {
                    console.error('âŒ [PASO 5] Respuesta invÃ¡lida del servidor');
                    console.error('   Respuesta recibida:', resultado);
                    throw new Error('Respuesta invÃ¡lida del servidor: falta campo "acceso"');
                }
                
                console.log('âœ… [PASO 5] Respuesta vÃ¡lida');
                console.log('   Acceso:', resultado.acceso);
                console.log('   Estado:', resultado.estado);
                console.log('   DÃ­as restantes:', resultado.diasRestantes);
                
                // Si la URL trae RUT, validar que corresponda al alumno
                if (rutFromUrl) {
                    var rutCheck = validateChileanRut(rutFromUrl);
                    if (!rutCheck.valid) {
                        showCustomAlert('RUT invÃ¡lido', 'El RUT del enlace no tiene un formato vÃ¡lido (ej: 12345678-9).', 'error');
                        return;
                    }
                    var alumnoRut = (resultado.alumno && resultado.alumno.rut) ? String(resultado.alumno.rut).trim() : '';
                    if (!alumnoRut) {
                        showCustomAlert('RUT no registrado', 'Este alumno no tiene RUT registrado. No se puede validar el RUT del QR.', 'warning');
                        return;
                    }
                    if (normalizeRut(alumnoRut) !== rutCheck.normalized) {
                        showCustomAlert('RUT no corresponde', 'El RUT del QR no corresponde a este alumno. No se mostrarÃ¡n datos.', 'error');
                        return;
                    }
                }
                
                // PASO 6: Procesar resultado
                console.log('ğŸ¨ [PASO 6] Procesando resultado y renderizando...');
                await handleValidationResult(resultado, cleanId);
                console.log('âœ… [PASO 6] Resultado renderizado correctamente');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœ… VALIDACIÃ“N COMPLETADA EXITOSAMENTE');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ ERROR EN VALIDACIÃ“N');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('   Tipo de error:', error.name);
                console.error('   Mensaje:', error.message);
                console.error('   Stack:', error.stack);
                
                // PASO 7: Manejar errores de forma explÃ­cita
                console.log('ğŸ” [PASO 7] Manejando error...');
                
                let mensajeError = 'Error al validar la suscripciÃ³n';
                let tituloError = 'Error de validaciÃ³n';
                
                if (error.message.includes('404') || error.message.includes('no encontrado')) {
                    tituloError = 'Alumno no encontrado';
                    mensajeError = `No se encontrÃ³ un alumno con el ID: ${cleanId}\n\n` +
                                   'Verifica que el ID sea correcto.';
                } else if (error.message.includes('400') || error.message.includes('requerido')) {
                    tituloError = 'Datos incompletos';
                    mensajeError = 'El alumno no tiene todos los datos necesarios para validar la suscripciÃ³n.\n\n' +
                                   'Contacta al administrador.';
                } else if (error.message.includes('500') || error.message.includes('Error interno')) {
                    tituloError = 'Error del servidor';
                    mensajeError = 'El servidor encontrÃ³ un error al procesar la solicitud.\n\n' +
                                   'Por favor intenta nuevamente mÃ¡s tarde.';
                } else if (error.message.includes('Failed to fetch') || 
                          error.message.includes('NetworkError') ||
                          error.message.includes('Network request failed')) {
                    tituloError = 'Error de conexiÃ³n';
                    mensajeError = 'No se pudo conectar con el servidor de validaciÃ³n.\n\n' +
                                   'Verifica:\n' +
                                   '1. Tu conexiÃ³n a internet\n' +
                                   '2. Que el backend estÃ© disponible\n' +
                                   '3. Que la URL de MongoDB API estÃ© configurada correctamente';
                } else {
                    tituloError = 'Error desconocido';
                    mensajeError = `Error: ${error.message || 'Error desconocido'}\n\n` +
                                   'Por favor contacta al administrador.';
                }
                
                console.error('   TÃ­tulo del error:', tituloError);
                console.error('   Mensaje del error:', mensajeError);
                
                // Mostrar error de forma explÃ­cita
                showCustomAlert(tituloError, mensajeError, 'error');
                
                // Asegurar que se muestre la secciÃ³n de bÃºsqueda
                const searchSection = document.querySelector('.search-section');
                if (searchSection) {
                    searchSection.style.display = 'block';
                }
                
                // Asegurar que el contenedor de resultado estÃ© oculto
                const resultContainer = document.getElementById('resultContainer');
                if (resultContainer) {
                    resultContainer.style.display = 'none';
                }
                
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ VALIDACIÃ“N FALLIDA - ERROR MOSTRADO AL USUARIO');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            }
        }
        
        // ============================================================
        // FUNCIÃ“N AUXILIAR: Manejar resultado de validaciÃ³n
        // ============================================================
        async function handleValidationResult(resultado, cleanId) {
            console.log('ğŸ¨ [handleValidationResult] Procesando resultado...');
            console.log('   Acceso:', resultado.acceso);
            console.log('   Estado:', resultado.estado);
            console.log('   Alumno:', resultado.alumno?.nombre);
            
            // Validar estructura
            if (!resultado || typeof resultado.acceso !== 'boolean') {
                console.error('âŒ [handleValidationResult] Respuesta invÃ¡lida');
                throw new Error('Respuesta invÃ¡lida del servidor: falta campo "acceso"');
            }
            
            if (!resultado.alumno) {
                console.error('âŒ [handleValidationResult] Respuesta sin datos de alumno');
                throw new Error('Respuesta invÃ¡lida del servidor: falta campo "alumno"');
            }
            
            // Guardar alumno actual
            currentStudent = resultado.alumno;
            console.log('âœ… [handleValidationResult] Alumno guardado:', currentStudent.nombre);
            
            // Convertir respuesta del backend al formato esperado por showStudentResult
            const estado = {
                acceso: resultado.acceso,
                estado: resultado.estado,
                diasRestantes: resultado.diasRestantes,
                proximoPago: resultado.proximoPago,
                mensaje: resultado.mensaje,
                // Para compatibilidad con UI existente
                clase: resultado.acceso ? 'al-dia' : 'atrasado',
                texto: resultado.mensaje,
                proximo: resultado.proximoPago ? new Date(resultado.proximoPago).toLocaleDateString('es-ES') : '---'
            };
            
            console.log('âœ… [handleValidationResult] Estado formateado:', estado);
            
            // Renderizar resultado
            console.log('ğŸ¨ [handleValidationResult] Llamando a showStudentResult()...');
            showStudentResult(resultado.alumno, estado);
            console.log('âœ… [handleValidationResult] Resultado renderizado');
            
            // Actualizar tÃ­tulo de la pÃ¡gina
            document.title = `Estado de Pago - ${resultado.alumno.nombre}`;
            console.log('âœ… [handleValidationResult] TÃ­tulo actualizado');
        }

        // ============================================================
        // FUNCIÃ“N: Mostrar resultado de validaciÃ³n
        // ============================================================
        // REGLA: SIEMPRE mostrar algo (Ã©xito o error explÃ­cito)
        // NO estados vacÃ­os, NO silencios
        // ============================================================
        function showStudentResult(alumno, estado) {
            console.log('ğŸ¨ [showStudentResult] INICIANDO renderizado');
            console.log('   Alumno:', alumno?.nombre);
            console.log('   Estado recibido:', estado);
            
            // Validar parÃ¡metros
            if (!alumno) {
                console.error('âŒ [showStudentResult] Alumno no proporcionado');
                showCustomAlert('Error', 'No se pudo obtener la informaciÃ³n del alumno', 'error');
                return;
            }
            
            if (!estado) {
                console.error('âŒ [showStudentResult] Estado no proporcionado');
                showCustomAlert('Error', 'No se pudo obtener el estado de la suscripciÃ³n', 'error');
                return;
            }
            
            console.log('âœ… [showStudentResult] ParÃ¡metros vÃ¡lidos');
            
            // Actualizar icono y estado - basado en respuesta binaria del backend
            const statusIcon = document.getElementById('statusIcon');
            const paymentStatus = document.getElementById('paymentStatus');
            
            if (estado.acceso === true) {
                // SuscripciÃ³n ACTIVA
                if (estado.diasRestantes <= 5) {
                statusIcon.textContent = 'âš ï¸';
                statusIcon.className = 'status-icon status-proximo';
                    paymentStatus.textContent = `ğŸŸ  PrÃ³ximo a vencer (${estado.diasRestantes} dÃ­as)`;
                paymentStatus.className = 'status-proximo';
            } else {
                    statusIcon.textContent = 'âœ…';
                    statusIcon.className = 'status-icon status-aldia';
                    paymentStatus.textContent = `ğŸŸ¢ Al dÃ­a con los pagos (${estado.diasRestantes} dÃ­as restantes)`;
                    paymentStatus.className = 'status-aldia';
                }
            } else {
                // SuscripciÃ³n VENCIDA
                statusIcon.textContent = 'âŒ';
                statusIcon.className = 'status-icon status-atrasado';
                paymentStatus.textContent = `ğŸ”´ Pago atrasado (${Math.abs(estado.diasRestantes)} dÃ­as)`;
                paymentStatus.className = 'status-atrasado';
            }
            
            document.getElementById('studentName').textContent = alumno.nombre;
            
            // Mostrar alerta si es necesario
            const alertBanner = document.getElementById('alertBanner');
            if (estado.acceso === false) {
                // VENCIDA
                alertBanner.innerHTML = `
                    <h3>ğŸš¨ PAGO ATRASADO</h3>
                    <p>Tu pago estÃ¡ atrasado por ${Math.abs(estado.diasRestantes)} dÃ­as. Por favor contacta a la administraciÃ³n.</p>
                `;
                alertBanner.className = 'alert-banner atrasado';
                alertBanner.style.display = 'block';
            } else if (estado.acceso === true && estado.diasRestantes <= 5) {
                // ACTIVA pero prÃ³ximo a vencer
                alertBanner.innerHTML = `
                    <h3>âš ï¸ PRÃ“XIMO A VENCER</h3>
                    <p>Tu pago vence en ${estado.diasRestantes} dÃ­as. Te recomendamos realizar el pago pronto.</p>
                `;
                alertBanner.className = 'alert-banner proximo';
                alertBanner.style.display = 'block';
            } else {
                alertBanner.style.display = 'none';
            }
            
            // Construir URL completa del alumno
            const baseUrl = 'https://cohabregistro-firstproyect.pages.dev';
            const studentUrl = `${baseUrl}/usuario.html?id=${alumno.id}`;
            
            // Mostrar informaciÃ³n completa
            const resultInfo = document.getElementById('resultInfo');
            resultInfo.innerHTML = `
                <div class="info-item">
                    <div class="label">ID</div>
                    <div class="value" style="font-family: monospace; font-size: 0.85rem; word-break: break-all;">${alumno.id}</div>
                </div>
                <div class="info-item">
                    <div class="label">Nombre</div>
                    <div class="value" style="font-weight: bold; font-size: 1.1rem;">${alumno.nombre}</div>
                </div>
                <div class="info-item">
                    <div class="label">Email</div>
                    <div class="value">${alumno.email || 'No especificado'}</div>
                </div>
                <div class="info-item">
                    <div class="label">TelÃ©fono</div>
                    <div class="value">${alumno.telefono || 'No especificado'}</div>
                </div>
                <div class="info-item">
                    <div class="label">Ãšltimo Pago</div>
                    <div class="value">${formatDate(alumno.fechaPago)}</div>
                </div>
                <div class="info-item">
                    <div class="label">PrÃ³ximo Pago</div>
                    <div class="value">${estado.proximoPago ? formatDate(new Date(estado.proximoPago)) : '---'}</div>
                </div>
                <div class="info-item">
                    <div class="label">Monto Mensual</div>
                    <div class="value" style="font-weight: bold; color: #dc2626; font-size: 1.1rem;">$${parseFloat(alumno.monto || 0).toFixed(2)}</div>
                </div>
                <div class="info-item">
                    <div class="label">Estado</div>
                    <div class="value" style="font-weight: bold;">${estado.mensaje || estado.texto || (estado.diasRestantes < 0 ? Math.abs(estado.diasRestantes) + ' dÃ­as atrasado' : estado.diasRestantes + ' dÃ­as restantes')}</div>
                </div>
                <div class="info-item" style="border-top: 2px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
                    <div class="label" style="color: #dc2626; font-weight: bold;">ğŸ”— URL Directa</div>
                    <div class="value" style="font-family: monospace; font-size: 0.8rem; word-break: break-all; background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;" onclick="navigator.clipboard.writeText('${studentUrl}').then(() => alert('âœ… URL copiada al portapapeles')).catch(() => alert('URL: ' + '${studentUrl}'))" title="Clic para copiar">${studentUrl}</div>
                </div>
            `;
            
            // FORZAR VISIBILIDAD DEL RESULTADO
            const resultContainer = document.getElementById('resultContainer');
            if (resultContainer) {
                resultContainer.style.display = 'block';
                resultContainer.style.visibility = 'visible';
                resultContainer.style.opacity = '1';
                console.log('âœ… [showStudentResult] Contenedor de resultado FORZADO a visible');
            } else {
                console.error('âŒ [showStudentResult] No se encontrÃ³ resultContainer');
                showCustomAlert('Error', 'No se pudo mostrar el resultado. Error en la estructura de la pÃ¡gina.', 'error');
                return;
            }
            
            // Ocultar bÃºsqueda manual
            const manualSearch = document.getElementById('manualSearch');
            if (manualSearch) {
                manualSearch.style.display = 'none';
            }
            
            // Scroll suave al resultado despuÃ©s de un breve delay
            setTimeout(() => {
                if (resultContainer) {
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    console.log('âœ… [showStudentResult] Scroll al resultado ejecutado');
                }
            }, 200);
            
            console.log('âœ… [showStudentResult] Renderizado completado exitosamente');
            console.log('   Acceso:', estado.acceso);
            console.log('   Estado:', estado.estado);
            console.log('   DÃ­as restantes:', estado.diasRestantes);
        }

        // Cerrar resultado
        function closeResult() {
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('userIdInput').value = '';
            currentStudent = null;
        }

        // Mostrar historial
        function showHistory() {
            alert('FunciÃ³n de historial en desarrollo...');
        }

        // Compartir URL del alumno
        function shareStudentUrl() {
            if (!currentStudent) {
                alert('No hay informaciÃ³n de alumno para compartir');
                return;
            }
            
            const currentUrl = window.location.href;
            
            if (navigator.share) {
                // Usar Web Share API si estÃ¡ disponible
                navigator.share({
                    title: `Estado de Pago - ${currentStudent.nombre}`,
                    text: `Consulta el estado de pago de ${currentStudent.nombre}`,
                    url: currentUrl
                }).catch(err => {
                    console.log('Error al compartir:', err);
                    copyToClipboard(currentUrl);
                });
            } else {
                // Fallback: copiar al portapapeles
                copyToClipboard(currentUrl);
            }
        }

        // Copiar al portapapeles
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showCustomAlert('URL Copiada', 'La URL ha sido copiada al portapapeles. Puedes compartirla con otros.', 'success');
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        // Fallback para copiar al portapapeles
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showCustomAlert('URL Copiada', 'La URL ha sido copiada al portapapeles. Puedes compartirla con otros.', 'success');
            } catch (err) {
                console.error('Error al copiar:', err);
                showCustomAlert('Error', 'No se pudo copiar la URL automÃ¡ticamente. CÃ³piala manualmente: ' + text, 'error');
            }
            document.body.removeChild(textArea);
        }

        // Formatear fecha
        function parseLocalDate(value) {
            if (!value) return null;
            if (value instanceof Date) {
                return new Date(value.getFullYear(), value.getMonth(), value.getDate());
            }
            if (typeof value === 'string') {
                const match = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (match) {
                    const year = Number(match[1]);
                    const month = Number(match[2]) - 1;
                    const day = Number(match[3]);
                    return new Date(year, month, day);
                }
            }
            const parsed = new Date(value);
            if (!isNaN(parsed.getTime())) {
                return new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate());
            }
            return null;
        }

        function formatDate(date) {
            const d = parseLocalDate(date);
            if (!d) return '---';
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // NOTA: La funciÃ³n calcularEstado() fue eliminada.
        // Ahora el cÃ¡lculo se hace en el backend (endpoint GET /alumnos/:id/validar)
        // Esta es la fuente Ãºnica de verdad para el estado de suscripciones.

        // ============================================================
        // INICIALIZACIÃ“N DE PÃGINA - FLUJO OBLIGATORIO
        // ============================================================
        // REGLA: Si hay ID en URL â†’ SIEMPRE disparar validaciÃ³n
        // NO hay excepciones, NO hay silencios, SIEMPRE mostrar resultado o error
        // ============================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸš€ [INICIO] Inicializando usuario.html');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“ URL completa:', window.location.href);
            console.log('ğŸ” Query params:', window.location.search);
            console.log('ğŸ›¤ï¸ Pathname:', window.location.pathname);
            
            // PASO 1: Extraer ID y RUT (opcional) de la URL
            const studentId = getStudentIdFromUrl();
            const rutFromUrl = getRutFromUrl();
            console.log('ğŸ†” [INICIO] ID detectado en URL:', studentId);
            if (rutFromUrl) console.log('   RUT en URL:', rutFromUrl);
            
            if (rutFromUrl && studentId) {
                var rutValid = validateChileanRut(rutFromUrl);
                if (!rutValid.valid) {
                    var searchSection = document.querySelector('.search-section');
                    if (searchSection) searchSection.innerHTML = '<div style="text-align:center;padding:2rem;"><p style="color:#dc2626;font-weight:bold;">RUT invÃ¡lido</p><p>El RUT del enlace no tiene un formato vÃ¡lido (ej: 12345678-9).</p></div>';
                    return;
                }
            }
            
            if (studentId) {
                console.log('âœ… [INICIO] Modo acceso pÃºblico detectado');
                console.log('   ID extraÃ­do:', studentId);
                console.log('   AcciÃ³n: Disparar validaciÃ³n inmediatamente');
                
                // Mostrar indicador de carga
                const searchSection = document.querySelector('.search-section');
                if (searchSection) {
                    searchSection.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">â³</div>
                            <p style="font-size: 1.1rem; color: #666;">Validando suscripciÃ³n...</p>
                            <p style="font-size: 0.9rem; color: #999; margin-top: 0.5rem;">Por favor espera</p>
                        </div>
                    `;
                }
                
                // Cambiar tÃ­tulo de la pÃ¡gina
                const welcomeH1 = document.querySelector('.user-welcome h1');
                const welcomeP = document.querySelector('.user-welcome p');
                if (welcomeH1) welcomeH1.textContent = 'ğŸ“± Estado de Pago';
                if (welcomeP) welcomeP.textContent = 'Validando tu suscripciÃ³n...';
                
                try {
                    // DISPARAR VALIDACIÃ“N INMEDIATAMENTE
                    // NO cargar alumnos desde la nube primero
                    // La validaciÃ³n se hace directamente con el endpoint
                    console.log('ğŸ“¡ [INICIO] Disparando validaciÃ³n con ID:', studentId);
                    await searchByUserId(studentId, { rutFromUrl: rutFromUrl });
                    
                    // Ocultar secciÃ³n de bÃºsqueda despuÃ©s de validar
                    if (searchSection) {
                        searchSection.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.error('âŒ [INICIO] ERROR CRÃTICO en inicializaciÃ³n');
                    console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.error('   Error:', error);
                    console.error('   Stack:', error.stack);
                    
                    // ERROR EXPLÃCITO: No silenciar errores
                    showCustomAlert(
                        'Error al cargar informaciÃ³n',
                        'No se pudo validar la suscripciÃ³n.\n\n' +
                        'Error: ' + (error.message || 'Error desconocido') + '\n\n' +
                        'Por favor intenta nuevamente o contacta al administrador.',
                        'error'
                    );
                    
                    // Mostrar opciones de bÃºsqueda en caso de error
                if (searchSection) {
                        searchSection.style.display = 'block';
                        searchSection.innerHTML = ''; // Restaurar contenido original
                    }
                }
            } else {
                // Comportamiento normal para usuarios (sin ID en URL)
                console.log('ğŸ‘¤ [INICIO] Modo usuario normal (sin ID en URL)');
                console.log('   AcciÃ³n: Verificar acceso de usuario');
                
                if (checkUserAccess()) {
                    console.log('âœ… [INICIO] Usuario tiene acceso');
                    // Cargar alumnos desde la nube si estÃ¡ disponible (solo para bÃºsqueda manual)
                    await loadAlumnosFromCloud();
                } else {
                    console.log('âŒ [INICIO] Usuario sin acceso');
                }
            }
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('âœ… [INICIO] InicializaciÃ³n completada');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        });
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registrado exitosamente:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Error al registrar ServiceWorker:', error);
                    });
            });
        }
    </script>
</body>
</html>
